#!/usr/bin/env Rscript

################################################################################
# Peak-Gene Linkage Analysis for GABA Neurons - Separate Genotypes
# (UPDATED VERSION - Using Pre-computed Links)
#
# This is the separate genotypes version that analyzes 4 groups independently:
# - Nestin-Ctrl, Nestin-Mut, Emx1-Ctrl, Emx1-Mut
#
# KEY CHANGE: Loads pre-computed LinkPeaks generated by array job scripts instead of manual cor.test()
#
# PREREQUISITES: Run peak-gene linkage array jobs first:
#   sbatch run_peak_gene_linkage_high_priority_L1.sh  OR
#   sbatch run_peak_gene_linkage_all_L1.sh            OR
#   sbatch run_signac_peak_gene_linkage_single_L1.sh GABA Nestin
#   sbatch run_signac_peak_gene_linkage_single_L1.sh GABA Emx1
#
# Input files:
#   - /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/integration_scripts/multiome_modular_pipeline/signac_results_L1/integrated_seurat_processed.rds
#   - /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/integration_scripts/multiome_modular_pipeline/genes_inter.txt
#   - /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/integration_scripts/multiome_modular_pipeline/signac_results_L1/celltype_results/peak_gene_links/GABA_Nestin_peak_gene_links.csv (generated by array jobs)
#   - /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/integration_scripts/multiome_modular_pipeline/signac_results_L1/celltype_results/peak_gene_links/GABA_Emx1_peak_gene_links.csv (generated by array jobs)
#
# Output:
#   - /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/integration_scripts/multiome_modular_pipeline/signac_results_L1/peak_gene_linkage_analysis_UPDATED/GABA_separate/peak_gene_links/{gene}_links_separate.csv
#   - /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/integration_scripts/multiome_modular_pipeline/signac_results_L1/peak_gene_linkage_analysis_UPDATED/GABA_separate/coverage_plots/{gene}_coverage_separate.pdf
#   - /beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/integration_scripts/multiome_modular_pipeline/signac_results_L1/peak_gene_linkage_analysis_UPDATED/GABA_separate/analysis_summary_separate.csv
################################################################################

# Load required libraries
suppressPackageStartupMessages({
  library(Signac)
  library(Seurat)
  library(GenomicRanges)
  library(BSgenome.Mmusculus.UCSC.mm10)
  library(EnsDb.Mmusculus.v79)
  library(ggplot2)
  library(dplyr)
  library(tidyr)
  library(patchwork)
  library(ggforce)
})

# Configuration
RESULTS_DIR <- "signac_results_L1"
SEURAT_FILE <- file.path(RESULTS_DIR, "integrated_seurat_processed.rds")
GENE_LIST_FILE <- "../genes_inter.txt"
OUTPUT_DIR <- file.path(RESULTS_DIR, "peak_gene_linkage_analysis_UPDATED", "GABA_separate")
STEP3_LINKS_DIR <- file.path(RESULTS_DIR, "celltype_results", "peak_gene_links")

# Cell type columns
CELLTYPE_COL <- "cell_type_L1"
CELL_TYPE <- "GABA"
CONDITION_COL <- "condition"
GENOTYPE_COL <- "genotype"

# Plotting parameters
EXTEND_UPSTREAM <- 50000
EXTEND_DOWNSTREAM <- 50000

# Create output directories
dir.create(OUTPUT_DIR, recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(OUTPUT_DIR, "peak_gene_links"), recursive = TRUE, showWarnings = FALSE)
dir.create(file.path(OUTPUT_DIR, "coverage_plots"), recursive = TRUE, showWarnings = FALSE)

cat("================================================================================\n")
cat("GABA NEURONS: Separate Genotypes (Using Pre-computed Links from Step 3)\n")
cat("================================================================================\n\n")

################################################################################
# Load Data
################################################################################

cat("Loading data...\n")
seurat_obj <- readRDS(SEURAT_FILE)
genes_of_interest <- read.table(GENE_LIST_FILE, header = FALSE)$V1 %>% unique()

# Filter mt-genes
mt_genes <- grepl("^mt-", genes_of_interest, ignore.case = TRUE)
if (any(mt_genes)) {
  cat(sprintf("  Filtering %d mt-genes\n", sum(mt_genes)))
  genes_of_interest <- genes_of_interest[!mt_genes]
}

cat(sprintf("  ✓ %d genes to analyze\n", length(genes_of_interest)))

################################################################################
# Load Pre-computed Links
################################################################################

cat("\nLoading pre-computed links from Step 3...\n")

# Link files generated by run_peak_gene_linkage_*_L1.sh array jobs
link_files <- c(
  Nestin = file.path(STEP3_LINKS_DIR, "GABA_Nestin_peak_gene_links.csv"),
  Emx1 = file.path(STEP3_LINKS_DIR, "GABA_Emx1_peak_gene_links.csv")
)

# Check if files exist
missing_files <- link_files[!file.exists(link_files)]
if (length(missing_files) > 0) {
  cat("\n✗ ERROR: Pre-computed LinkPeaks not found:\n")
  for (f in missing_files) {
    cat(sprintf("  - %s\n", f))
  }
  cat("\nYou must run peak-gene linkage first:\n")
  cat("  Option 1: sbatch run_peak_gene_linkage_high_priority_L1.sh\n")
  cat("  Option 2: sbatch run_peak_gene_linkage_all_L1.sh\n")
  cat("  Option 3: sbatch run_signac_peak_gene_linkage_single_L1.sh GABA Nestin\n")
  cat("            sbatch run_signac_peak_gene_linkage_single_L1.sh GABA Emx1\n\n")
  stop("Pre-computed LinkPeaks not found. Run peak-gene linkage first.")
}

# Load links and preserve original genotype names (capitalized)
all_links_list <- lapply(names(link_files), function(geno) {
  df <- read.csv(link_files[[geno]])
  # Ensure genotype column exists and is consistent
  if (!"genotype" %in% colnames(df)) {
    df$genotype <- geno
  }
  df
})
all_links <- do.call(rbind, all_links_list)

# Filter to genes of interest
links_filtered <- all_links %>% filter(gene %in% genes_of_interest)

cat(sprintf("  ✓ Loaded %d links for %d genes\n",
            nrow(links_filtered),
            length(unique(links_filtered$gene))))

if (nrow(links_filtered) == 0) {
  stop("No links found for genes of interest")
}

################################################################################
# Subset to GABA & Create Separate Groups
################################################################################

cat("\nSubsetting to GABA neurons...\n")
gaba_cells <- seurat_obj@meta.data %>%
  filter(.data[[CELLTYPE_COL]] == CELL_TYPE) %>%
  rownames()

seurat_gaba <- subset(seurat_obj, cells = gaba_cells)
cat(sprintf("  ✓ %d GABA neurons\n", ncol(seurat_gaba)))

# Create genotype_condition variable (4 groups)
seurat_gaba@meta.data$genotype_condition <- paste0(
  seurat_gaba@meta.data[[GENOTYPE_COL]], "-",
  seurat_gaba@meta.data[[CONDITION_COL]]
)

cat("\nGroup distribution:\n")
print(table(seurat_gaba@meta.data$genotype_condition))

Idents(seurat_gaba) <- seurat_gaba@meta.data$genotype_condition

################################################################################
# Create Visualizations
################################################################################

cat("\n================================================================================\n")
cat("CREATING VISUALIZATIONS\n")
cat("================================================================================\n\n")

summary_stats <- data.frame(
  gene = character(),
  status = character(),
  n_links_nestin = integer(),
  n_links_emx1 = integer(),
  stringsAsFactors = FALSE
)

genes_to_process <- unique(links_filtered$gene)

for (gene in genes_to_process) {
  cat(sprintf("--- %s ---\n", gene))

  # Validate gene in ATAC annotation
  gene_in_atac <- tryCatch({
    coords <- LookupGeneCoords(seurat_gaba, gene = gene, assay = "ATAC")
    !is.null(coords) && length(coords) > 0
  }, error = function(e) FALSE)

  if (!gene_in_atac) {
    cat("  ⚠ Gene not in ATAC annotation\n")
    summary_stats <- rbind(summary_stats, data.frame(
      gene = gene, status = "missing_annotation",
      n_links_nestin = 0, n_links_emx1 = 0
    ))
    next
  }

  # Get links for this gene
  gene_links <- links_filtered %>% filter(gene == !!gene)

  n_nestin <- sum(gene_links$genotype == "Nestin")
  n_emx1 <- sum(gene_links$genotype == "Emx1")

  cat(sprintf("  %d links (Nestin: %d, Emx1: %d)\n", nrow(gene_links), n_nestin, n_emx1))

  # Save CSV
  write.csv(gene_links,
            file.path(OUTPUT_DIR, "peak_gene_links", sprintf("%s_links_separate.csv", gene)),
            row.names = FALSE)

  # Create coverage plot
  plot_success <- tryCatch({
    DefaultAssay(seurat_gaba) <- "ATAC"

    # Parse peak coordinates
    if ("seqnames" %in% colnames(gene_links)) {
      peak_gr <- GRanges(
        seqnames = gene_links$seqnames,
        ranges = IRanges(start = as.numeric(gene_links$start),
                        end = as.numeric(gene_links$end)),
        score = gene_links$score
      )
    } else if ("peak" %in% colnames(gene_links)) {
      coords <- do.call(rbind, strsplit(as.character(gene_links$peak), "-"))
      peak_gr <- GRanges(
        seqnames = coords[, 1],
        ranges = IRanges(start = as.numeric(coords[, 2]),
                        end = as.numeric(coords[, 3])),
        score = gene_links$score
      )
    } else {
      cat("  ⚠ Cannot parse peak coordinates\n")
      return(FALSE)
    }

    # Create Link objects
    gene_coords <- LookupGeneCoords(seurat_gaba, gene = gene, assay = "ATAC")
    gene_start <- start(gene_coords)

    link_list <- lapply(seq_along(peak_gr), function(i) {
      peak_center <- (start(peak_gr[i]) + end(peak_gr[i])) / 2
      GRanges(
        seqnames = as.character(seqnames(peak_gr[i])),
        ranges = IRanges(
          start = min(peak_center, gene_start),
          end = max(peak_center, gene_start)
        ),
        score = peak_gr[i]$score
      )
    })

    all_link_gr <- do.call(c, link_list)
    Links(seurat_gaba[["ATAC"]]) <- all_link_gr

    cat(sprintf("  Added %d links to ATAC assay\n", length(all_link_gr)))

    # Create coverage plot
    p_cov <- CoveragePlot(
      object = seurat_gaba,
      region = gene,
      features = gene,
      expression.assay = "RNA",
      assay = "ATAC",
      group.by = "genotype_condition",
      extend.upstream = EXTEND_UPSTREAM,
      extend.downstream = EXTEND_DOWNSTREAM,
      annotation = TRUE,
      peaks = TRUE,
      links = TRUE,
      window = 100
    )

    plot_file <- file.path(OUTPUT_DIR, "coverage_plots",
                          sprintf("%s_coverage_separate.pdf", gene))
    ggsave(plot_file, plot = p_cov, width = 14, height = 12, device = "pdf")
    cat(sprintf("  ✓ Saved: %s\n", basename(plot_file)))

    TRUE
  }, error = function(e) {
    cat(sprintf("  ✗ Plot error: %s\n", e$message))
    FALSE
  })

  summary_stats <- rbind(summary_stats, data.frame(
    gene = gene,
    status = ifelse(plot_success, "success", "failed"),
    n_links_nestin = n_nestin,
    n_links_emx1 = n_emx1
  ))
}

################################################################################
# Save Summary
################################################################################

cat("\n================================================================================\n")
cat("SUMMARY\n")
cat("================================================================================\n\n")

summary_file <- file.path(OUTPUT_DIR, "analysis_summary_separate.csv")
write.csv(summary_stats, summary_file, row.names = FALSE)

cat(sprintf("Total genes: %d\n", nrow(summary_stats)))
cat(sprintf("Successful: %d\n", sum(summary_stats$status == "success")))
cat(sprintf("Failed: %d\n", sum(summary_stats$status == "failed")))

cat(sprintf("\n✓ Results saved to: %s\n", OUTPUT_DIR))
