#!/usr/bin/env Rscript

# Load extracted h5ad data into R
# Generated by extract_h5ad_to_r.py

library(Matrix)
library(Seurat)

cat("Loading extracted h5ad data...\n")

# File paths
output_dir <- "/beegfs/scratch/ric.sessa/kubacki.michal/SRF_Linda_top/SRF_Linda_RNA/combine_data/results_from_raw/extracted_for_r"

# Load metadata
metadata <- read.csv(file.path(output_dir, "cell_metadata.csv"), row.names = 1)
cat("  ✓ Metadata:", nrow(metadata), "cells ×", ncol(metadata), "columns\n")

# Load gene metadata  
gene_metadata <- read.csv(file.path(output_dir, "gene_metadata.csv"), row.names = 1)
cat("  ✓ Gene metadata:", nrow(gene_metadata), "genes ×", ncol(gene_metadata), "columns\n")

# Load cell and gene names
cell_names <- scan(file.path(output_dir, "cell_names.txt"), what = character(), quiet = TRUE)
gene_names <- scan(file.path(output_dir, "gene_names.txt"), what = character(), quiet = TRUE)

# Load expression matrix (Matrix Market format)
expr_sparse <- readMM(file.path(output_dir, "expression_matrix.mtx"))
cat("  ✓ Expression matrix:", nrow(expr_sparse), "×", ncol(expr_sparse), "\n")

# Check if dimensions need to be transposed
if (nrow(expr_sparse) == length(cell_names) && ncol(expr_sparse) == length(gene_names)) {
  # Matrix is cells × genes, transpose to genes × cells
  cat("  Transposing matrix from cells × genes to genes × cells\n")
  expr_sparse <- t(expr_sparse)
}

# Set proper dimnames with error handling
tryCatch({
  rownames(expr_sparse) <- gene_names
  colnames(expr_sparse) <- cell_names
  cat("  ✓ Successfully set dimnames\n")
}, error = function(e) {
  cat("  ⚠ Warning: Could not set dimnames directly\n")
  cat("    Creating new matrix with proper dimnames\n")
  
  # Convert to dgCMatrix and set dimnames
  expr_sparse <- as(expr_sparse, "dgCMatrix")
  rownames(expr_sparse) <- gene_names[1:nrow(expr_sparse)]
  colnames(expr_sparse) <- cell_names[1:ncol(expr_sparse)]
})

# Create Seurat object
seurat_obj <- CreateSeuratObject(
  counts = expr_sparse,
  assay = "RNA",
  meta.data = metadata,
  min.cells = 0,
  min.features = 0
)

# Add embeddings
emb_files <- list.files(output_dir, pattern = "embedding_.*\\.csv$", full.names = TRUE)

for (emb_file in emb_files) {
  emb_name <- gsub("embedding_(.*)\\.csv$", "\1", basename(emb_file))
  cat("  Adding embedding:", emb_name, "\n")
  
  emb_data <- as.matrix(read.csv(emb_file, row.names = 1))
  colnames(emb_data) <- paste0(emb_name, "_", seq_len(ncol(emb_data)))
  
  reduction_obj <- CreateDimReducObject(
    embeddings = emb_data,
    key = paste0(emb_name, "_"),
    assay = "RNA"
  )
  
  seurat_obj[[emb_name]] <- reduction_obj
}

# Save the final object
output_rds <- file.path(output_dir, "annotation_final_reconstructed.rds")
saveRDS(seurat_obj, output_rds)

cat("\n✅ Successfully created Seurat object!\n")
cat("Output:", output_rds, "\n")
cat("Object size:", round(file.info(output_rds)$size / 1024^2, 1), "MB\n")
cat("\nTo use:\n")
cat("  seurat_obj <- readRDS('", output_rds, "')\n", sep = "")
